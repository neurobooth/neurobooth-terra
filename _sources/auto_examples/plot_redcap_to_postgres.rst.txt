
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/plot_redcap_to_postgres.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download_auto_examples_plot_redcap_to_postgres.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_plot_redcap_to_postgres.py:


======================================
Ingest table from Redcap into Postgres
======================================

This example demonstrates how to create table from Redcap.

.. GENERATED FROM PYTHON SOURCE LINES 8-19

.. code-block:: default


    # Authors: Mainak Jas <mjas@harvard.mgh.edu>

    import os
    import os.path as op

    import json
    from redcap import Project, RedcapError

    from neurobooth_terra.ingest_redcap import fetch_survey, infer_schema








.. GENERATED FROM PYTHON SOURCE LINES 20-24

Let us first define the surveys and their survey IDs that we want to fetch.
This information can be found on Redcap. To fetch Redcap data, you will
also need to define the NEUROBOOTH_REDCAP_TOKEN environment variable.
You will need to request for the Redcap API token from Redcap interface.

.. GENERATED FROM PYTHON SOURCE LINES 24-36

.. code-block:: default


    survey_ids = {'consent': 84349, 'contact': 84427, 'demographics': 84429,
                  'clinical': 84431, 'falls': 85031}

    URL = 'https://redcap.partners.org/redcap/api/'
    API_KEY = os.environ.get('NEUROBOOTH_REDCAP_TOKEN')

    if API_KEY is None:
        raise ValueError('Please define the environment variable NEUROBOOTH_REDCAP_TOKEN first')

    project = Project(URL, API_KEY, lazy=True)








.. GENERATED FROM PYTHON SOURCE LINES 37-41

Next, we fetch the metadata table. This table is the master table
that contains columns and their informations. It can be used to infer
information about the columns: example, what choices are available for a
particular question.

.. GENERATED FROM PYTHON SOURCE LINES 41-51

.. code-block:: default


    print('Fetching metadata ...')
    metadata = project.export_metadata(format='df')
    metadata_fields = ['field_label', 'form_name', 'section_header',
                       'field_type', 'select_choices_or_calculations',
                       'required_field']
    metadata = metadata[metadata_fields]
    # metadata.to_csv(op.join(data_dir, 'data_dictionary.csv'), index=False)
    print('[Done]')





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Fetching metadata ...
    [Done]




.. GENERATED FROM PYTHON SOURCE LINES 52-53

Finally, we loop over the surveys and print out the schema.

.. GENERATED FROM PYTHON SOURCE LINES 53-58

.. code-block:: default

    json_schema = dict()
    for survey_name, survey_id in survey_ids.items():
        df = fetch_survey(project, survey_name, survey_id)
        json_schema[survey_name] = infer_schema(df, metadata)
    print(json.dumps(json_schema[survey_name], indent=4, sort_keys=True))




.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Fetching report consent from Redcap
    [Done]
    Skipping redcap_repeat_instrument
    Skipping redcap_repeat_instance
    Fetching report contact from Redcap
    [Done]
    Skipping redcap_repeat_instrument
    Skipping redcap_repeat_instance
    Skipping contact_information_complete
    Fetching report demographics from Redcap
    [Done]
    Skipping redcap_repeat_instrument
    Skipping redcap_repeat_instance
    Skipping race___1
    Skipping race___2
    Skipping race___3
    Skipping race___4
    Skipping race___5
    Skipping race___6
    Skipping race___7
    Skipping health_history___1
    Skipping health_history___2
    Skipping health_history___3
    Skipping health_history___4
    Skipping health_history___5
    Skipping health_history___6
    Skipping health_history___diabetes
    Skipping health_history___7
    Skipping health_history___8
    Skipping health_history___9
    Skipping health_history___10
    Skipping health_history___11
    Skipping health_history___12
    Skipping health_history___13
    Skipping health_history___14
    Skipping health_history___15
    Skipping health_history___16
    Skipping health_history___17
    Skipping health_history___18
    Skipping health_history___19
    Skipping health_history___20
    Skipping health_history___21
    Skipping health_history___22
    Skipping health_history___23
    Skipping health_history___24
    Skipping health_history___25
    Skipping health_history___26
    Skipping health_history___27
    Skipping health_history___28
    Skipping health_history___29
    Skipping health_history___30
    Skipping health_history___31
    Skipping health_history___32
    Skipping health_history___33
    Skipping health_history___34
    Skipping health_history___35
    Skipping health_history___36
    Skipping health_history___37
    Skipping demographics_complete
    Fetching report clinical from Redcap
    [Done]
    Skipping redcap_repeat_instrument
    Skipping redcap_repeat_instance
    Skipping primary_diagnosis___0
    Skipping primary_diagnosis___1
    Skipping primary_diagnosis___2
    Skipping primary_diagnosis___3
    Skipping primary_diagnosis___4
    Skipping primary_diagnosis___5
    Skipping primary_diagnosis___6
    Skipping primary_diagnosis___7
    Skipping primary_diagnosis___8
    Skipping primary_diagnosis___9
    Skipping primary_diagnosis___10
    Skipping primary_diagnosis___12
    Skipping primary_diagnosis___13
    Skipping primary_diagnosis___14
    Skipping primary_diagnosis___15
    Skipping primary_diagnosis___16
    Skipping primary_diagnosis___17
    Skipping primary_diagnosis___18
    Skipping primary_diagnosis___19
    Skipping primary_diagnosis___20
    Skipping primary_diagnosis___21
    Skipping primary_diagnosis___22
    Skipping clinical_information_survey_complete
    Fetching report falls from Redcap
    [Done]
    Skipping redcap_repeat_instrument
    Skipping redcap_repeat_instance
    Skipping neurobooth_falls_complete
    {
        "falls_12mo": {
            "choices": {},
            "field_type": "yesno",
            "mode": "NULLABLE",
            "name": "falls_12mo",
            "question": "Have you fallen in the past 12 months?",
            "type": "float"
        },
        "falls_3mo": {
            "choices": {},
            "field_type": "yesno",
            "mode": "NULLABLE",
            "name": "falls_3mo",
            "question": "Have you fallen in the past 3 months?",
            "type": "float"
        },
        "falls_6mo": {
            "choices": {},
            "field_type": "yesno",
            "mode": "NULLABLE",
            "name": "falls_6mo",
            "question": "Have you fallen in the past 6 months?",
            "type": "float"
        },
        "n_falls_12_mo": {
            "choices": {
                "0": "1-3 times",
                "1": "4-6 times",
                "2": "6-10 times",
                "3": "10-15 times",
                "4": "more than 15 times"
            },
            "field_type": "radio",
            "mode": "NULLABLE",
            "name": "n_falls_12_mo",
            "question": "How many times have you fallen in the past 12 months?",
            "type": "float"
        },
        "n_falls_3_mo": {
            "choices": {
                "0": "1-3 times",
                "1": "4-6 times",
                "2": "6-10 times",
                "3": "10-15 times",
                "4": "more than 15 times"
            },
            "field_type": "radio",
            "mode": "NULLABLE",
            "name": "n_falls_3_mo",
            "question": "How many times have you fallen in the past 3 months?",
            "type": "float"
        },
        "n_falls_6_mo": {
            "choices": {
                "0": "1-3 times",
                "1": "4-6 times",
                "2": "6-10 times",
                "3": "10-15 times",
                "4": "more than 15 times"
            },
            "field_type": "radio",
            "mode": "NULLABLE",
            "name": "n_falls_6_mo",
            "question": "How many times have you fallen in the past 6 months?",
            "type": "float"
        },
        "neurobooth_falls_complete": {
            "choices": {},
            "field_type": "",
            "mode": "NULLABLE",
            "name": "neurobooth_falls_complete",
            "question": "",
            "type": "float"
        },
        "prom_ataxi_27": {
            "choices": {
                "0": "Without any difficulty",
                "1": "With a little difficulty",
                "2": "With some difficulty",
                "3": "With much difficulty",
                "4": "Unable to do"
            },
            "field_type": "radio",
            "mode": "NULLABLE",
            "name": "prom_ataxi_27",
            "question": "I can walk without assistance (without a cane, walker, personal aid, wheelchair)",
            "type": "float"
        },
        "prom_ataxia_1": {
            "choices": {
                "0": "Never",
                "1": "Rarely",
                "2": "Sometimes",
                "3": "Often",
                "4": "Always"
            },
            "field_type": "radio",
            "mode": "NULLABLE",
            "name": "prom_ataxia_1",
            "question": "I feel unsteady on my feet when standing/walking on flat surfaces",
            "type": "float"
        },
        "prom_ataxia_2": {
            "choices": {
                "0": "Never",
                "1": "Rarely",
                "2": "Sometimes",
                "3": "Often",
                "4": "Always"
            },
            "field_type": "radio",
            "mode": "NULLABLE",
            "name": "prom_ataxia_2",
            "question": "I lose my balance walking/hiking on uneven surfaces, including hills and sand/beach",
            "type": "float"
        },
        "prom_ataxia_26": {
            "choices": {
                "0": "Without any difficulty",
                "1": "With a little difficulty",
                "2": "With some difficulty",
                "3": "With much difficulty",
                "4": "Unable to do"
            },
            "field_type": "radio",
            "mode": "NULLABLE",
            "name": "prom_ataxia_26",
            "question": "I can carry things in my arms while walking (e.g., furniture, packages, babies, etc.)",
            "type": "float"
        },
        "prom_ataxia_28": {
            "choices": {
                "0": "Without any difficulty",
                "1": "With a little difficulty",
                "2": "With some difficulty",
                "3": "With much difficulty",
                "4": "Unable to do"
            },
            "field_type": "radio",
            "mode": "NULLABLE",
            "name": "prom_ataxia_28",
            "question": "I can catch myself and prevent a fall when I stumble",
            "type": "float"
        },
        "prom_ataxia_3": {
            "choices": {
                "0": "Never",
                "1": "Rarely",
                "2": "Sometimes",
                "3": "Often",
                "4": "Always"
            },
            "field_type": "radio",
            "mode": "NULLABLE",
            "name": "prom_ataxia_3",
            "question": "I feel as though I may lose my balance and fall",
            "type": "float"
        },
        "prom_ataxia_30": {
            "choices": {
                "0": "Without any difficulty",
                "1": "With a little difficulty",
                "2": "With some difficulty",
                "3": "With much difficulty",
                "4": "Unable to do"
            },
            "field_type": "radio",
            "mode": "NULLABLE",
            "name": "prom_ataxia_30",
            "question": "I can bend down and pick something off the floor without help",
            "type": "float"
        },
        "prom_ataxia_31": {
            "choices": {
                "0": "Without any difficulty",
                "1": "With a little difficulty",
                "2": "With some difficulty",
                "3": "With much difficulty",
                "4": "Unable to do"
            },
            "field_type": "radio",
            "mode": "NULLABLE",
            "name": "prom_ataxia_31",
            "question": "I can get up off the floor without help",
            "type": "float"
        },
        "prom_ataxia_4": {
            "choices": {
                "0": "Never",
                "1": "Rarely",
                "2": "Sometimes",
                "3": "Often",
                "4": "Always"
            },
            "field_type": "radio",
            "mode": "NULLABLE",
            "name": "prom_ataxia_4",
            "question": "I lose my balance on stairs/ladders/stepstools",
            "type": "float"
        },
        "prom_ataxia_5": {
            "choices": {
                "0": "Never",
                "1": "Rarely",
                "2": "Sometimes",
                "3": "Often",
                "4": "Always"
            },
            "field_type": "radio",
            "mode": "NULLABLE",
            "name": "prom_ataxia_5",
            "question": "I am clumsy",
            "type": "float"
        },
        "prom_ataxia_6": {
            "choices": {
                "0": "Never",
                "1": "Rarely",
                "2": "Sometimes",
                "3": "Often",
                "4": "Always"
            },
            "field_type": "radio",
            "mode": "NULLABLE",
            "name": "prom_ataxia_6",
            "question": "I find myself stumbling and/or falling",
            "type": "float"
        },
        "record_id": {
            "choices": {},
            "field_type": "text",
            "mode": "NULLABLE",
            "name": "record_id",
            "question": "Subject Identification",
            "type": "integer"
        },
        "redcap_repeat_instance": {
            "choices": {},
            "field_type": "",
            "mode": "NULLABLE",
            "name": "redcap_repeat_instance",
            "question": "",
            "type": "float"
        },
        "redcap_repeat_instrument": {
            "choices": {},
            "field_type": "",
            "mode": "NULLABLE",
            "name": "redcap_repeat_instrument",
            "question": "",
            "type": "string"
        }
    }





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  5.040 seconds)


.. _sphx_glr_download_auto_examples_plot_redcap_to_postgres.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download sphx-glr-download-python

     :download:`Download Python source code: plot_redcap_to_postgres.py <plot_redcap_to_postgres.py>`



  .. container:: sphx-glr-download sphx-glr-download-jupyter

     :download:`Download Jupyter notebook: plot_redcap_to_postgres.ipynb <plot_redcap_to_postgres.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
